name: iOS SDK Tests

on:
  push:
    branches: [main]
    paths:
      - 'ios-sdk/src/**'
      - 'ios-sdk/libs/test_ci.sh'
      - '.github/workflows/ios-sdk-tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'ios-sdk/src/**'
      - 'ios-sdk/libs/test_ci.sh'
      - '.github/workflows/ios-sdk-tests.yml'
  workflow_dispatch:

jobs:
  test:
    # Use macos-26 for access to Xcode with Swift 6.2.1+ and newer iOS SDK
    # CloudCommerce requires Swift 6.2.1+ and ProximityReader.StoreAndForwardStatus
    runs-on: macos-26
    timeout-minutes: 360
    
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          # IMPORTANT: Use latest-stable to match local development environment (Swift 6.2.3)
          # This ensures binary framework compatibility between CI and local builds
          # If your local Xcode version differs, update this to match your local version
          # CloudCommerce.xcframework requires Swift 6.2.1+ and newer iOS SDK for ProximityReader
          xcode-version: latest-stable
      
      - name: Cache DerivedData and SourcePackages
        uses: actions/cache@v4
        with:
          path: |
            DerivedData-Tests
            ~/Library/Developer/Xcode/DerivedData
            ~/Library/Caches/org.swift.swiftpm
            DerivedData-Tests/SourcePackages
          key: ${{ runner.os }}-xcode-tests-${{ hashFiles('ios-sdk/src/AriseMobileSdk.xcodeproj/project.pbxproj', 'ios-sdk/src/AriseMobileSdk.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-xcode-tests-
            ${{ runner.os }}-xcode-
          # Increase cache size limit for large Swift packages
          # SourcePackages can be several GB for swift-crypto and dependencies
      
      - name: Verify Swift and Xcode versions
        run: |
          echo "Xcode version:"
          xcodebuild -version
          echo ""
          echo "Swift version:"
          swift --version
          echo ""
          echo "Full Swift version details:"
          xcrun swift --version
      
      - name: Create and Boot iOS Simulator
        run: |
          echo "ğŸ“± Setting up iOS Simulator for tests..."
          
          # List available runtimes
          echo "Available iOS runtimes:"
          xcrun simctl list runtimes available | grep iOS || true
          
          # Get the latest iOS runtime identifier (e.g., "iOS-18-2" or "com.apple.CoreSimulator.SimRuntime.iOS-18-2")
          # Try to get the runtime identifier directly
          LATEST_RUNTIME_ID=$(xcrun simctl list runtimes available | grep -i "iOS" | tail -1 | awk '{print $NF}' | tr -d '()')
          
          if [ -z "$LATEST_RUNTIME_ID" ]; then
            # Fallback: try to extract version number and construct identifier
            RUNTIME_VERSION=$(xcrun simctl list runtimes available | grep -i "iOS" | tail -1 | sed -E 's/.*iOS[^0-9]*([0-9]+)[^0-9]*([0-9]+).*/\1-\2/' | head -1)
            if [ -n "$RUNTIME_VERSION" ]; then
              LATEST_RUNTIME_ID="iOS-$RUNTIME_VERSION"
            else
              # Last resort: try to find any iOS runtime
              LATEST_RUNTIME_ID=$(xcrun simctl list runtimes available | grep -i "iOS" | head -1 | awk '{print $NF}' | tr -d '()')
            fi
          fi
          
          if [ -z "$LATEST_RUNTIME_ID" ]; then
            echo "âŒ No iOS runtime found. Available runtimes:"
            xcrun simctl list runtimes available
            exit 1
          fi
          
          echo "ğŸ“± Using iOS runtime: $LATEST_RUNTIME_ID"
          
          # Check if a simulator already exists (check for any booted iPhone first, then available)
          EXISTING_BOOTED=$(xcrun simctl list devices | grep -i "iPhone" | grep "Booted" | head -1 | sed 's/.*(\([A-F0-9-]*\)).*/\1/')
          
          if [ -n "$EXISTING_BOOTED" ]; then
            echo "âœ… Found booted iPhone simulator: $EXISTING_BOOTED"
            SIMULATOR_ID="$EXISTING_BOOTED"
          else
            # Check for any available iPhone simulator
            EXISTING_SIMULATOR=$(xcrun simctl list devices available | grep -i "iPhone" | head -1 | sed 's/.*(\([A-F0-9-]*\)).*/\1/')
            
            if [ -n "$EXISTING_SIMULATOR" ]; then
              echo "âœ… Found existing iPhone simulator: $EXISTING_SIMULATOR"
              SIMULATOR_ID="$EXISTING_SIMULATOR"
            else
              # Create a new iPhone simulator
              echo "ğŸ“± Creating new iPhone simulator..."
              SIMULATOR_NAME="iPhone 15 Pro"
              SIMULATOR_ID=$(xcrun simctl create "$SIMULATOR_NAME" "iPhone 15 Pro" "$LATEST_RUNTIME_ID" 2>&1)
              CREATE_EXIT_CODE=$?
              
              if [ $CREATE_EXIT_CODE -eq 0 ] && [ -n "$SIMULATOR_ID" ]; then
                # Success - extract UUID if needed
                if echo "$SIMULATOR_ID" | grep -qE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}'; then
                  SIMULATOR_ID=$(echo "$SIMULATOR_ID" | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}' | head -1)
                fi
                echo "âœ… Created simulator: $SIMULATOR_NAME (ID: $SIMULATOR_ID)"
              else
                echo "âš ï¸  Failed to create iPhone 15 Pro, trying iPhone 14 Pro..."
                SIMULATOR_NAME="iPhone 14 Pro"
                SIMULATOR_ID=$(xcrun simctl create "$SIMULATOR_NAME" "iPhone 14 Pro" "$LATEST_RUNTIME_ID" 2>&1)
                CREATE_EXIT_CODE=$?
                
                if [ $CREATE_EXIT_CODE -eq 0 ] && [ -n "$SIMULATOR_ID" ]; then
                  if echo "$SIMULATOR_ID" | grep -qE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}'; then
                    SIMULATOR_ID=$(echo "$SIMULATOR_ID" | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}' | head -1)
                  fi
                  echo "âœ… Created simulator: $SIMULATOR_NAME (ID: $SIMULATOR_ID)"
                else
                  echo "âš ï¸  Failed to create iPhone 14 Pro, trying generic iPhone..."
                  SIMULATOR_NAME="iPhone"
                  SIMULATOR_ID=$(xcrun simctl create "$SIMULATOR_NAME" "iPhone" "$LATEST_RUNTIME_ID" 2>&1)
                  CREATE_EXIT_CODE=$?
                  
                  if [ $CREATE_EXIT_CODE -eq 0 ] && [ -n "$SIMULATOR_ID" ]; then
                    if echo "$SIMULATOR_ID" | grep -qE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}'; then
                      SIMULATOR_ID=$(echo "$SIMULATOR_ID" | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}' | head -1)
                    fi
                    echo "âœ… Created simulator: $SIMULATOR_NAME (ID: $SIMULATOR_ID)"
                  else
                    echo "âŒ Failed to create simulator. Error: $SIMULATOR_ID"
                    echo "Available device types:"
                    xcrun simctl list devicetypes | grep -i "iPhone" | head -5
                    exit 1
                  fi
                fi
              fi
            fi
          fi
          
          # Boot the simulator
          echo "ğŸš€ Booting simulator: $SIMULATOR_ID"
          xcrun simctl boot "$SIMULATOR_ID" || {
            # If already booted, that's fine
            if xcrun simctl list devices | grep "$SIMULATOR_ID" | grep -q "Booted"; then
              echo "âœ… Simulator already booted"
            else
              echo "âŒ Failed to boot simulator"
              exit 1
            fi
          }
          
          # Wait for simulator to be ready
          echo "â³ Waiting for simulator to be ready..."
          timeout=60
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if xcrun simctl list devices | grep "$SIMULATOR_ID" | grep -q "Booted"; then
              # Check if simulator is actually ready by checking its state
              STATE=$(xcrun simctl list devices | grep "$SIMULATOR_ID" | grep -oE "(Booted|Shutdown)")
              if [ "$STATE" = "Booted" ]; then
                echo "âœ… Simulator is ready"
                break
              fi
            fi
            sleep 2
            elapsed=$((elapsed + 2))
            echo "   Waiting... ($elapsed/$timeout seconds)"
          done
          
          if [ $elapsed -ge $timeout ]; then
            echo "âš ï¸  Simulator boot timeout, but continuing..."
          fi
          
          # Verify simulator is available
          echo "ğŸ“± Verifying simulator availability..."
          xcrun simctl list devices | grep "$SIMULATOR_ID" || echo "âš ï¸  Simulator not found in list"
          
          echo "âœ… Simulator setup complete: $SIMULATOR_ID"
      
      - name: Run Tests
        timeout-minutes: 360
        run: |
          # Make test script executable
          chmod +x ios-sdk/libs/test_ci.sh
          
          # Run tests using CI script
          ./ios-sdk/libs/test_ci.sh
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results.xcresult
            /tmp/test_output.log
          retention-days: 30
          if-no-files-found: warn
      
      - name: Generate Test Coverage Report
        if: always()
        run: |
          if [ -d "./test-results.xcresult" ]; then
            echo "ğŸ“Š Generating test coverage report using project scripts..."
            
            # Make scripts executable
            chmod +x ios-sdk/coverage/scripts/*.sh 2>/dev/null || true
            
            # Generate coverage report using project script
            if [ -f "ios-sdk/coverage/scripts/generate_coverage_report.sh" ]; then
              echo "âœ… Using generate_coverage_report.sh..."
              cd ios-sdk/coverage/scripts
              bash generate_coverage_report.sh "../../../test-results.xcresult" || {
                echo "âš ï¸  generate_coverage_report.sh failed, trying detailed report..."
                bash generate_detailed_coverage.sh "../../../test-results.xcresult" || {
                  echo "âš ï¸  Detailed report also failed, using fallback"
                }
              }
              cd ../../..
            elif [ -f "ios-sdk/coverage/scripts/generate_detailed_coverage.sh" ]; then
              echo "âœ… Using generate_detailed_coverage.sh..."
              cd ios-sdk/coverage/scripts
              bash generate_detailed_coverage.sh "../../../test-results.xcresult" || echo "âš ï¸  Detailed report generation failed"
              cd ../../..
            else
              echo "âš ï¸  Coverage report scripts not found, using fallback..."
            fi
            
            # Also run check_coverage.sh for summary
            if [ -f "ios-sdk/coverage/scripts/check_coverage.sh" ]; then
              echo ""
              echo "ğŸ“‹ Running coverage check..."
              cd ios-sdk/coverage/scripts
              bash check_coverage.sh 75 "../../../test-results.xcresult" || echo "âš ï¸  Coverage check failed"
              cd ../../..
            fi
            
            # Display generated reports if they exist
            if [ -f "ios-sdk/coverage/coverage_report.md" ]; then
              echo ""
              echo "âœ… Coverage report generated: ios-sdk/coverage/coverage_report.md"
              echo "ğŸ“„ Report preview (first 50 lines):"
              head -50 ios-sdk/coverage/coverage_report.md || true
            fi
            
            if [ -f "ios-sdk/coverage/detailed_coverage_report.md" ]; then
              echo ""
              echo "âœ… Detailed coverage report generated: ios-sdk/coverage/detailed_coverage_report.md"
            fi
          else
            echo "âš ï¸  Test results bundle not found at ./test-results.xcresult"
          fi
      
      - name: Upload Coverage Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            ios-sdk/coverage/coverage_report.md
            ios-sdk/coverage/detailed_coverage_report.md
          retention-days: 30
          if-no-files-found: warn

