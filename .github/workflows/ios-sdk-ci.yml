name: iOS SDK CI

on:
  push:
    branches: [main]
    paths:
      - 'ios-sdk/**'
      - '.github/workflows/ios-sdk-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'ios-sdk/**'
      - '.github/workflows/ios-sdk-ci.yml'
  workflow_dispatch:

jobs:
  build-test-and-release:
    # Use macos-26 for access to Xcode with Swift 6.2.1+ and newer iOS SDK
    # CloudCommerce requires Swift 6.2.1+ and ProximityReader.StoreAndForwardStatus
    runs-on: macos-26
    timeout-minutes: 360
    
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          # IMPORTANT: Use latest-stable to match local development environment (Swift 6.2.3)
          # This ensures binary framework compatibility between CI and local builds
          # If your local Xcode version differs, update this to match your local version
          # CloudCommerce.xcframework requires Swift 6.2.1+ and newer iOS SDK for ProximityReader
          xcode-version: latest-stable
      
      - name: Cache DerivedData and SourcePackages
        uses: actions/cache@v4
        with:
          path: |
            DerivedData-Tests
            ~/Library/Developer/Xcode/DerivedData
            ~/Library/Caches/org.swift.swiftpm
            DerivedData-Tests/SourcePackages
            ios-sdk/libs/Build
          key: ${{ runner.os }}-xcode-ci-${{ hashFiles('ios-sdk/src/AriseMobileSdk.xcodeproj/project.pbxproj', 'ios-sdk/src/AriseMobileSdk.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-xcode-ci-
            ${{ runner.os }}-xcode-
      
      - name: Verify Swift and Xcode versions
        run: |
          echo "Xcode version:"
          xcodebuild -version
          echo ""
          echo "Swift version:"
          swift --version
          echo ""
          echo "Full Swift version details:"
          xcrun swift --version
          echo ""
          echo "âš ï¸  NOTE: Using latest-stable Xcode to match local development environment"
          echo "âš ï¸  If you encounter Swift version mismatch errors, ensure CI and local Xcode versions match"
          echo "âš ï¸  CloudCommerce.xcframework requires Swift 6.2.1+ and newer iOS SDK for ProximityReader"
      
      - name: Get version from Info.plist
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        id: get_version
        run: |
          VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" ios-sdk/src/AriseMobileSdk/AriseMobileSdk-Info.plist)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"
          echo "ðŸ·ï¸  Tag: v$VERSION"
      
      - name: Check if tag already exists
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        id: check_tag
        run: |
          TAG="${{ steps.get_version.outputs.tag }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  Tag $TAG already exists, skipping release"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Tag $TAG does not exist, proceeding with release"
          fi
      
      - name: Check if only framework files changed
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.check_tag.outputs.exists == 'false'
        id: check_framework_only
        run: |
          # Get list of changed files in the commit
          if [ "${{ github.event_name }}" == "push" ]; then
            # For push events, compare with previous commit
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only origin/main HEAD 2>/dev/null || echo "")
          else
            # For workflow_dispatch, check what files exist
            CHANGED_FILES=$(git ls-files ios-sdk/libs/AriseMobile.xcframework 2>/dev/null || echo "")
          fi
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "framework_only=false" >> $GITHUB_OUTPUT
            echo "build_needed=true" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ No changed files detected or workflow_dispatch - will build"
            exit 0
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check if only framework files changed (no source code changes)
          FRAMEWORK_ONLY=true
          BUILD_NEEDED=false
          
          # List of paths that indicate source code changes (require rebuild)
          SOURCE_PATTERNS=(
            "ios-sdk/src/"
            "ios-sdk/Distribution/Sources/"
            "ios-sdk/Distribution/Package.swift"
            "*.swift"
            "*.m"
            "*.h"
            "*.xcodeproj"
            "*.pbxproj"
            "build_framework"
            "build_framework_ci"
            "build_and_test_ci"
          )
          
          # Check each changed file
          while IFS= read -r file; do
            if [ -z "$file" ]; then
              continue
            fi
            
            # Skip if it's a framework file
            if [[ "$file" == *"AriseMobile.xcframework"* ]] || \
               [[ "$file" == *"CloudCommerce.xcframework"* ]] || \
               [[ "$file" == *"ios-sdk/libs/"* ]] && [[ "$file" != *"build_framework"* ]] && [[ "$file" != *"build_and_test"* ]]; then
              echo "  âœ… Framework file: $file (skip)"
              continue
            fi
            
            # Check if it matches source code patterns
            IS_SOURCE=false
            for pattern in "${SOURCE_PATTERNS[@]}"; do
              if [[ "$file" == *"$pattern"* ]]; then
                IS_SOURCE=true
                break
              fi
            done
            
            if [ "$IS_SOURCE" = true ]; then
              echo "  ðŸ”¨ Source code file: $file (requires build)"
              FRAMEWORK_ONLY=false
              BUILD_NEEDED=true
              break
            else
              echo "  ðŸ“„ Other file: $file"
            fi
          done <<< "$CHANGED_FILES"
          
          echo "framework_only=$FRAMEWORK_ONLY" >> $GITHUB_OUTPUT
          echo "build_needed=$BUILD_NEEDED" >> $GITHUB_OUTPUT
          
          if [ "$FRAMEWORK_ONLY" = true ]; then
            echo "âœ… Only framework files changed - will use existing framework"
          else
            echo "ðŸ”¨ Source code changed - will build new framework"
          fi
      
      - name: Verify existing framework exists
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.check_tag.outputs.exists == 'false' && steps.check_framework_only.outputs.framework_only == 'true'
        id: verify_framework
        run: |
          FRAMEWORK_PATH="ios-sdk/libs/AriseMobile.xcframework"
          
          if [ -d "$FRAMEWORK_PATH" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Existing framework found at: $FRAMEWORK_PATH"
            
            # Verify framework structure
            if [ -f "$FRAMEWORK_PATH/Info.plist" ]; then
              echo "âœ… Framework Info.plist found"
            else
              echo "âš ï¸  Warning: Framework Info.plist not found"
            fi
            
            # Check for device and simulator slices
            DEVICE_FW=$(find "$FRAMEWORK_PATH" -path "*/ios-arm64/*.framework" -type d | head -1)
            SIM_FW=$(find "$FRAMEWORK_PATH" -path "*simulator/*.framework" -type d | head -1)
            
            if [ -n "$DEVICE_FW" ]; then
              echo "âœ… Device framework found: $DEVICE_FW"
            else
              echo "âš ï¸  Warning: Device framework not found"
            fi
            
            if [ -n "$SIM_FW" ]; then
              echo "âœ… Simulator framework found: $SIM_FW"
            else
              echo "âš ï¸  Warning: Simulator framework not found (device-only is OK)"
            fi
            
            # Show framework size
            FRAMEWORK_SIZE=$(du -sh "$FRAMEWORK_PATH" 2>/dev/null | cut -f1)
            echo "Framework size: $FRAMEWORK_SIZE"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âŒ Framework not found at: $FRAMEWORK_PATH"
            echo "Will fall back to building"
          fi
      
      - name: Create and Boot iOS Simulator
        run: |
          echo "ðŸ“± Setting up iOS Simulator for tests..."
          
          # List available runtimes
          echo "Available iOS runtimes:"
          xcrun simctl list runtimes available | grep iOS || true
          
          # Get the latest iOS runtime identifier (e.g., "iOS-18-2" or "com.apple.CoreSimulator.SimRuntime.iOS-18-2")
          # Try to get the runtime identifier directly
          LATEST_RUNTIME_ID=$(xcrun simctl list runtimes available | grep -i "iOS" | tail -1 | awk '{print $NF}' | tr -d '()')
          
          if [ -z "$LATEST_RUNTIME_ID" ]; then
            # Fallback: try to extract version number and construct identifier
            RUNTIME_VERSION=$(xcrun simctl list runtimes available | grep -i "iOS" | tail -1 | sed -E 's/.*iOS[^0-9]*([0-9]+)[^0-9]*([0-9]+).*/\1-\2/' | head -1)
            if [ -n "$RUNTIME_VERSION" ]; then
              LATEST_RUNTIME_ID="iOS-$RUNTIME_VERSION"
            else
              # Last resort: try to find any iOS runtime
              LATEST_RUNTIME_ID=$(xcrun simctl list runtimes available | grep -i "iOS" | head -1 | awk '{print $NF}' | tr -d '()')
            fi
          fi
          
          if [ -z "$LATEST_RUNTIME_ID" ]; then
            echo "âŒ No iOS runtime found. Available runtimes:"
            xcrun simctl list runtimes available
            exit 1
          fi
          
          echo "ðŸ“± Using iOS runtime: $LATEST_RUNTIME_ID"
          
          # Check if a simulator already exists (check for any booted iPhone first, then available)
          EXISTING_BOOTED=$(xcrun simctl list devices | grep -i "iPhone" | grep "Booted" | head -1 | sed 's/.*(\([A-F0-9-]*\)).*/\1/')
          
          if [ -n "$EXISTING_BOOTED" ]; then
            echo "âœ… Found booted iPhone simulator: $EXISTING_BOOTED"
            SIMULATOR_ID="$EXISTING_BOOTED"
          else
            # Check for any available iPhone simulator
            EXISTING_SIMULATOR=$(xcrun simctl list devices available | grep -i "iPhone" | head -1 | sed 's/.*(\([A-F0-9-]*\)).*/\1/')
            
            if [ -n "$EXISTING_SIMULATOR" ]; then
              echo "âœ… Found existing iPhone simulator: $EXISTING_SIMULATOR"
              SIMULATOR_ID="$EXISTING_SIMULATOR"
            else
              # Create a new iPhone simulator
              echo "ðŸ“± Creating new iPhone simulator..."
              SIMULATOR_NAME="iPhone 15 Pro"
              SIMULATOR_ID=$(xcrun simctl create "$SIMULATOR_NAME" "iPhone 15 Pro" "$LATEST_RUNTIME_ID" 2>&1)
              CREATE_EXIT_CODE=$?
              
              if [ $CREATE_EXIT_CODE -eq 0 ] && [ -n "$SIMULATOR_ID" ]; then
                # Success - extract UUID if needed
                if echo "$SIMULATOR_ID" | grep -qE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}'; then
                  SIMULATOR_ID=$(echo "$SIMULATOR_ID" | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}' | head -1)
                fi
                echo "âœ… Created simulator: $SIMULATOR_NAME (ID: $SIMULATOR_ID)"
              else
                echo "âš ï¸  Failed to create iPhone 15 Pro, trying iPhone 14 Pro..."
                SIMULATOR_NAME="iPhone 14 Pro"
                SIMULATOR_ID=$(xcrun simctl create "$SIMULATOR_NAME" "iPhone 14 Pro" "$LATEST_RUNTIME_ID" 2>&1)
                CREATE_EXIT_CODE=$?
                
                if [ $CREATE_EXIT_CODE -eq 0 ] && [ -n "$SIMULATOR_ID" ]; then
                  if echo "$SIMULATOR_ID" | grep -qE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}'; then
                    SIMULATOR_ID=$(echo "$SIMULATOR_ID" | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}' | head -1)
                  fi
                  echo "âœ… Created simulator: $SIMULATOR_NAME (ID: $SIMULATOR_ID)"
                else
                  echo "âš ï¸  Failed to create iPhone 14 Pro, trying generic iPhone..."
                  SIMULATOR_NAME="iPhone"
                  SIMULATOR_ID=$(xcrun simctl create "$SIMULATOR_NAME" "iPhone" "$LATEST_RUNTIME_ID" 2>&1)
                  CREATE_EXIT_CODE=$?
                  
                  if [ $CREATE_EXIT_CODE -eq 0 ] && [ -n "$SIMULATOR_ID" ]; then
                    if echo "$SIMULATOR_ID" | grep -qE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}'; then
                      SIMULATOR_ID=$(echo "$SIMULATOR_ID" | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}' | head -1)
                    fi
                    echo "âœ… Created simulator: $SIMULATOR_NAME (ID: $SIMULATOR_ID)"
                  else
                    echo "âŒ Failed to create simulator. Error: $SIMULATOR_ID"
                    echo "Available device types:"
                    xcrun simctl list devicetypes | grep -i "iPhone" | head -5
                    exit 1
                  fi
                fi
              fi
            fi
          fi
          
          # Boot the simulator
          echo "ðŸš€ Booting simulator: $SIMULATOR_ID"
          xcrun simctl boot "$SIMULATOR_ID" || {
            # If already booted, that's fine
            if xcrun simctl list devices | grep "$SIMULATOR_ID" | grep -q "Booted"; then
              echo "âœ… Simulator already booted"
            else
              echo "âŒ Failed to boot simulator"
              exit 1
            fi
          }
          
          # Wait for simulator to be ready
          echo "â³ Waiting for simulator to be ready..."
          timeout=60
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if xcrun simctl list devices | grep "$SIMULATOR_ID" | grep -q "Booted"; then
              # Check if simulator is actually ready by checking its state
              STATE=$(xcrun simctl list devices | grep "$SIMULATOR_ID" | grep -oE "(Booted|Shutdown)")
              if [ "$STATE" = "Booted" ]; then
                echo "âœ… Simulator is ready"
                break
              fi
            fi
            sleep 2
            elapsed=$((elapsed + 2))
            echo "   Waiting... ($elapsed/$timeout seconds)"
          done
          
          if [ $elapsed -ge $timeout ]; then
            echo "âš ï¸  Simulator boot timeout, but continuing..."
          fi
          
          # Verify simulator is available
          echo "ðŸ“± Verifying simulator availability..."
          xcrun simctl list devices | grep "$SIMULATOR_ID" || echo "âš ï¸  Simulator not found in list"
          
          echo "âœ… Simulator setup complete: $SIMULATOR_ID"
      
      - name: Build XCFramework
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.check_tag.outputs.exists == 'false' && (steps.check_framework_only.outputs.build_needed == 'true' || (steps.check_framework_only.outputs.framework_only == 'true' && steps.verify_framework.outputs.exists != 'true'))
        run: |
          echo "ðŸ”¨ Building new framework..."
          cd ios-sdk/libs
          chmod +x build_and_test_ci.sh
          bash build_and_test_ci.sh build
          ls -lh AriseMobile.xcframework
      
      - name: Use existing framework
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.check_tag.outputs.exists == 'false' && steps.check_framework_only.outputs.framework_only == 'true' && steps.verify_framework.outputs.exists == 'true'
        run: |
          echo "âœ… Using existing framework from commit"
          echo "Framework location: ios-sdk/libs/AriseMobile.xcframework"
          ls -lh ios-sdk/libs/AriseMobile.xcframework
          
          # Verify framework is valid
          if [ ! -f "ios-sdk/libs/AriseMobile.xcframework/Info.plist" ]; then
            echo "âŒ Error: Framework Info.plist not found"
            exit 1
          fi
          
          echo "âœ… Existing framework verified and ready to use"
      
      - name: Run Tests
        timeout-minutes: 360
        run: |
          # Make combined build and test script executable
          chmod +x ios-sdk/libs/build_and_test_ci.sh
          
          # Run tests using combined CI script (test mode)
          ./ios-sdk/libs/build_and_test_ci.sh test
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results.xcresult
            /tmp/test_output.log
          retention-days: 30
          if-no-files-found: warn
      
      - name: Generate Test Coverage Report
        if: always()
        run: |
          if [ -d "./test-results.xcresult" ]; then
            echo "ðŸ“Š Generating test coverage report using project scripts..."
            
            # Make scripts executable
            chmod +x ios-sdk/coverage/scripts/*.sh 2>/dev/null || true
            
            # Generate coverage report using project script
            if [ -f "ios-sdk/coverage/scripts/generate_coverage_report.sh" ]; then
              echo "âœ… Using generate_coverage_report.sh..."
              cd ios-sdk/coverage/scripts
              bash generate_coverage_report.sh "../../../test-results.xcresult" || {
                echo "âš ï¸  generate_coverage_report.sh failed, trying detailed report..."
                bash generate_detailed_coverage.sh "../../../test-results.xcresult" || {
                  echo "âš ï¸  Detailed report also failed, using fallback"
                }
              }
              cd ../../..
            elif [ -f "ios-sdk/coverage/scripts/generate_detailed_coverage.sh" ]; then
              echo "âœ… Using generate_detailed_coverage.sh..."
              cd ios-sdk/coverage/scripts
              bash generate_detailed_coverage.sh "../../../test-results.xcresult" || echo "âš ï¸  Detailed report generation failed"
              cd ../../..
            else
              echo "âš ï¸  Coverage report scripts not found, using fallback..."
            fi
            
            # Also run check_coverage.sh for summary
            if [ -f "ios-sdk/coverage/scripts/check_coverage.sh" ]; then
              echo ""
              echo "ðŸ“‹ Running coverage check..."
              cd ios-sdk/coverage/scripts
              bash check_coverage.sh 75 "../../../test-results.xcresult" || echo "âš ï¸  Coverage check failed"
              cd ../../..
            fi
            
            # Display generated reports if they exist
            if [ -f "ios-sdk/coverage/coverage_report.md" ]; then
              echo ""
              echo "âœ… Coverage report generated: ios-sdk/coverage/coverage_report.md"
              echo "ðŸ“„ Report preview (first 50 lines):"
              head -50 ios-sdk/coverage/coverage_report.md || true
            fi
            
            if [ -f "ios-sdk/coverage/detailed_coverage_report.md" ]; then
              echo ""
              echo "âœ… Detailed coverage report generated: ios-sdk/coverage/detailed_coverage_report.md"
            fi
          else
            echo "âš ï¸  Test results bundle not found at ./test-results.xcresult"
          fi
      
      - name: Upload Coverage Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            ios-sdk/coverage/coverage_report.md
            ios-sdk/coverage/detailed_coverage_report.md
          retention-days: 30
          if-no-files-found: warn
      
      - name: Detect Module Name from Project Settings
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.check_tag.outputs.exists == 'false'
        id: detect_module_name
        run: |
          # Get module name from project settings (this is the source of truth before build)
          MODULE_NAME=""
          
          # Check PRODUCT_MODULE_NAME from project settings (most reliable - this is what will be used in build)
          if [ -f "ios-sdk/src/AriseMobileSdk.xcodeproj/project.pbxproj" ]; then
            MODULE_NAME=$(grep "PRODUCT_MODULE_NAME" ios-sdk/src/AriseMobileSdk.xcodeproj/project.pbxproj | head -1 | sed -E 's/.*PRODUCT_MODULE_NAME[[:space:]]*=[[:space:]]*([^;]+);.*/\1/' | xargs)
            echo "Found module name in project.pbxproj: $MODULE_NAME"
          fi
          
          # Verify using xcodebuild showBuildSettings
          if [ -n "$MODULE_NAME" ] && [ "$MODULE_NAME" != "" ]; then
            VERIFIED=$(xcodebuild -showBuildSettings -project ios-sdk/src/AriseMobileSdk.xcodeproj -scheme AriseMobileSdk -configuration Debug -sdk iphoneos 2>/dev/null | grep "PRODUCT_MODULE_NAME" | head -1 | sed -E 's/.*PRODUCT_MODULE_NAME[[:space:]]*=[[:space:]]*(.+)/\1/' | xargs)
            if [ -n "$VERIFIED" ] && [ "$VERIFIED" != "$MODULE_NAME" ]; then
              echo "âš ï¸  Warning: project.pbxproj says $MODULE_NAME but xcodebuild shows $VERIFIED"
              MODULE_NAME="$VERIFIED"
            fi
          fi
          
          # Final fallback: default to AriseMobile (expected value)
          if [ -z "$MODULE_NAME" ] || [ "$MODULE_NAME" = "" ]; then
            MODULE_NAME="AriseMobile"
            echo "Using default module name: $MODULE_NAME"
          fi
          
          echo "module_name=$MODULE_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Detected module name: $MODULE_NAME"
      
      - name: Update Package.swift and Wrapper with Correct Module Name
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.check_tag.outputs.exists == 'false'
        run: |
          MODULE_NAME="${{ steps.detect_module_name.outputs.module_name }}"
          echo "Updating Package.swift and wrapper to use module name: $MODULE_NAME"
          
          # Update Package.swift using Python for cross-platform compatibility
          python3 << EOF
          import re
          
          module_name = "$MODULE_NAME"
          
          # Update Package.swift
          with open('ios-sdk/Distribution/Package.swift', 'r') as f:
              content = f.read()
          
          # Set package name to AriseMobileSdkIos (to avoid conflicts with module/class names)
          content = re.sub(r'name: "AriseMobileSdk"', 'name: "AriseMobileSdkIos"', content, count=1)
          
          # Set library product name to AriseMobileSdkIos (what users import)
          content = re.sub(r'\.library\(\s*name: "AriseMobileSDK"', '.library(\n            name: "AriseMobileSdkIos"', content)
          
          # Binary target name must match module name inside framework (AriseMobile)
          # Don't change binary target name - only update references if needed
          # Keep binary target as: name: "{module_name}" (should be AriseMobile)
          
          with open('ios-sdk/Distribution/Package.swift', 'w') as f:
              f.write(content)
          
          # Update wrapper
          wrapper_path = 'ios-sdk/Distribution/Sources/AriseMobileSdkIos/AriseMobileSdk.swift'
          with open(wrapper_path, 'r') as f:
              content = f.read()
          
          # Replace import statements
          content = re.sub(r'@_exported import AriseMobileSDK', f'@_exported import {module_name}', content)
          content = re.sub(r'@_exported import AriseMobileSdk', f'@_exported import {module_name}', content)
          
          with open(wrapper_path, 'w') as f:
              f.write(content)
          
          print(f"âœ… Updated files to use module name: {module_name}")
          EOF
          
          echo "Verifying changes:"
          echo "Package.swift binary target:"
          grep -E "binaryTarget|name:" ios-sdk/Distribution/Package.swift | head -5
          echo "Wrapper import:"
          grep "@_exported import" ios-sdk/Distribution/Sources/AriseMobileSdkIos/AriseMobileSdk.swift | head -1
      
      - name: Copy frameworks to distribution package
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.check_tag.outputs.exists == 'false'
        run: |
          # Ensure libs directory exists in distribution package
          mkdir -p ios-sdk/Distribution/libs
          
          # Copy AriseMobile.xcframework (either from build or existing)
          rm -rf ios-sdk/Distribution/libs/AriseMobile.xcframework
          
          if [ -d "ios-sdk/libs/AriseMobile.xcframework" ]; then
          cp -R ios-sdk/libs/AriseMobile.xcframework ios-sdk/Distribution/libs/
            echo "âœ… Framework copied to distribution package"
          else
            echo "âŒ Error: Framework not found at ios-sdk/libs/AriseMobile.xcframework"
            exit 1
          fi
          
          # Copy CloudCommerce.xcframework if it exists
          if [ -d "ios-sdk/libs/CloudCommerce.xcframework" ]; then
            rm -rf ios-sdk/Distribution/libs/CloudCommerce.xcframework
            cp -R ios-sdk/libs/CloudCommerce.xcframework ios-sdk/Distribution/libs/
          fi
          
          echo "âœ… Frameworks copied to distribution package"
          ls -lh ios-sdk/Distribution/libs/
      
      - name: Create archive with frameworks
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.check_tag.outputs.exists == 'false'
        run: |
          cd ios-sdk/Distribution
          zip -r AriseMobile-v${{ steps.get_version.outputs.version }}-xcframeworks.zip libs/
          ls -lh AriseMobile-v${{ steps.get_version.outputs.version }}-xcframeworks.zip
          echo "archive_path=ios-sdk/Distribution/AriseMobile-v${{ steps.get_version.outputs.version }}-xcframeworks.zip" >> $GITHUB_ENV
      
      - name: Upload xcframework artifact for deployment
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.check_tag.outputs.exists == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: ios-sdk-xcframework
          path: |
            ios-sdk/Distribution/AriseMobile-v${{ steps.get_version.outputs.version }}-xcframeworks.zip
            ios-sdk/Distribution/libs/
          retention-days: 90
          if-no-files-found: error
      
      - name: Setup distribution repository
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.check_tag.outputs.exists == 'false'
        run: |
          REPO_URL="https://x-access-token:${{ secrets.DISTRIBUTION_REPO_TOKEN }}@github.com/${{ secrets.DISTRIBUTION_REPO }}.git"
          mkdir -p distribution-repo
          cd distribution-repo
          
          # Try to clone the repository
          if git clone --depth=1 "$REPO_URL" . 2>/dev/null; then
            echo "âœ… Repository cloned successfully"
            # Fetch all branches
            git fetch --unshallow 2>/dev/null || git fetch origin
            # Check if main branch exists remotely
            if git ls-remote --heads origin main | grep -q main; then
              echo "Main branch exists, checking out..."
              git checkout main || git checkout -b main origin/main
            else
              # Try to determine default branch
              DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | awk '{print $NF}' || echo "main")
              echo "Main branch doesn't exist, checking out default branch: $DEFAULT_BRANCH"
              if [ "$DEFAULT_BRANCH" != "main" ] && git ls-remote --heads origin "$DEFAULT_BRANCH" | grep -q "$DEFAULT_BRANCH"; then
                git checkout "$DEFAULT_BRANCH" || git checkout -b main
              else
                git checkout -b main
              fi
            fi
          else
            echo "âš ï¸ Repository is empty, initializing..."
            git init
            git remote add origin "$REPO_URL" || git remote set-url origin "$REPO_URL"
            git checkout -b main
            echo "# AriseMobileSdk Distribution Repository" > README.md
            git add README.md
            git -c user.name="github-actions[bot]" -c user.email="github-actions[bot]@users.noreply.github.com" commit -m "Initial commit" || true
          fi
      
      - name: Configure git for distribution repo
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.check_tag.outputs.exists == 'false'
        working-directory: distribution-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Copy files to distribution repository
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.check_tag.outputs.exists == 'false'
        run: |
          # Copy Package.swift and other necessary files
          cp ios-sdk/Distribution/Package.swift distribution-repo/
          cp ios-sdk/Distribution/README.md distribution-repo/ 2>/dev/null || true
          
          # Copy Sources directory
          mkdir -p distribution-repo/Sources/AriseMobileSdkIos
          cp -R ios-sdk/Distribution/Sources/AriseMobileSdkIos/* distribution-repo/Sources/AriseMobileSdkIos/
          
          # Copy libs directory
          mkdir -p distribution-repo/libs
          cp -R ios-sdk/Distribution/libs/* distribution-repo/libs/
          
          echo "âœ… Files copied to distribution repository"
      
      - name: Commit and push to distribution repository
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.check_tag.outputs.exists == 'false'
        working-directory: distribution-repo
        run: |
          # Ensure we're on main branch
          git checkout main || git checkout -b main
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Release version ${{ steps.get_version.outputs.version }}"
            # Push with set-upstream if branch doesn't exist remotely
            git push -u origin main || git push origin main
            echo "âœ… Changes pushed to distribution repository"
          fi
      
      - name: Check if tag exists in distribution repository
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.check_tag.outputs.exists == 'false'
        id: check_dist_tag
        working-directory: distribution-repo
        run: |
          TAG="${{ steps.get_version.outputs.tag }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  Tag $TAG already exists in distribution repository, skipping tag creation"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Tag $TAG does not exist in distribution repository, will create it"
          fi
      
      - name: Create git tag
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.check_tag.outputs.exists == 'false' && steps.check_dist_tag.outputs.exists == 'false'
        working-directory: distribution-repo
        run: |
          TAG="${{ steps.get_version.outputs.tag }}"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          echo "âœ… Tag $TAG created and pushed"
      
      - name: Create GitHub Release
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.check_tag.outputs.exists == 'false' && steps.check_dist_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          repository: ${{ secrets.DISTRIBUTION_REPO }}
          token: ${{ secrets.DISTRIBUTION_REPO_TOKEN }}
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: AriseMobileSdk ${{ steps.get_version.outputs.tag }}
          body: |
            ## ðŸš€ AriseMobileSdk ${{ steps.get_version.outputs.tag }}
            
            ### ðŸ“¦ What's New
            
            Automatic release triggered by changes in ios-sdk/ directory.
            
            ### ðŸ“‹ Technical Details
            
            - **Minimum iOS version:** 15.0
            - **Minimum Xcode version:** 15.0
            - **Minimum Swift version:** 5.9
            
            ### ðŸ“¥ Installation
            
            ```swift
            dependencies: [
                .package(
                    url: "https://github.com/${{ secrets.DISTRIBUTION_REPO }}.git",
                    from: "${{ steps.get_version.outputs.version }}"
                )
            ]
            ```
            
            ---
            
            *This release was automatically created. To deploy a previously built artifact, use the "Deploy iOS SDK Release" workflow.*
          files: |
            ios-sdk/Distribution/AriseMobile-v${{ steps.get_version.outputs.version }}-xcframeworks.zip
          draft: false
          prerelease: false

